<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Generate Payment Link — Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <style>
    :root{
      --bg:#f6f8fb;--surface:#fff;--text:#0f172a;--muted:#64748b;--border:#e2e8f0;
      --primary:#3b82f6;--primary-hover:#2563eb;
      --crypto:#22c55e;--crypto-ink:#064e3b;
      --card:#f59e0b;--card-ink:#7c2d12;
      --success:#10b981;--success-bg:#d1fae5;--success-border:#a7f3d0;
      --error:#ef4444;--error-bg:#fee2e2;--error-border:#fecaca;
      --chip:#f1f5f9;
      --shadow:0 1px 3px rgba(0,0,0,.08),0 6px 24px rgba(15,23,42,.06);
      --shadow-lg:0 10px 30px rgba(15,23,42,.12);
      --radius:12px;--radius-sm:8px;--focus-ring:0 0 0 3px rgba(59,130,246,.15);
      --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      --rounded-2xl:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#f6f8fb 0%,#eef2f7 100%);color:var(--text);font:14px/1.55 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,sans-serif;min-height:100vh;display:flex;flex-direction:column}
    .header{backdrop-filter:saturate(140%) blur(6px);background:rgba(255,255,255,.85);border-bottom:1px solid var(--border);padding:14px 18px;position:sticky;top:0;z-index:10}
    .header-content{max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800;font-size:18px;letter-spacing:.2px}
    .brand-icon{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--primary-hover));display:grid;place-items:center;color:#fff;box-shadow:inset 0 0 0 1px rgba(255,255,255,.25)}
    .btn{display:inline-flex;align-items:center;gap:.55rem;padding:.6rem 1rem;border:1px solid var(--border);border-radius:10px;background:var(--surface);color:var(--text);text-decoration:none;font-weight:600;cursor:pointer;transition:.18s ease;box-shadow:0 1px 0 rgba(15,23,42,.02)}
    .btn:hover{transform:translateY(-1px);box-shadow:var(--shadow)}
    .btn:focus-visible{outline:none;box-shadow:var(--focus-ring),var(--shadow)}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-hover)}
    .container{max-width:1100px;margin:28px auto;padding:0 16px;flex:1;display:grid;gap:18px}
    .page-header{display:grid;gap:6px}
    .page-title{font-size:28px;margin:0;font-weight:800;letter-spacing:.1px}
    .page-description{color:var(--muted);margin:0}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:20px}
    .form{display:grid;gap:18px}
    .form-row{display:grid;gap:14px;grid-template-columns:1fr}
    @media (min-width:880px){.form-row.two{grid-template-columns:1.2fr .8fr}}
    .form-group{display:flex;flex-direction:column;gap:8px}
    .form-label{font-weight:700;font-size:.9rem}
    .required{color:var(--error);margin-left:4px}
    .hint{color:var(--muted);font-size:.8rem}
    .input{width:100%;padding:.8rem .9rem;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:.95rem;transition:.15s;border-color:#e5e7eb}
    .input:focus{outline:none;border-color:var(--primary);box-shadow:var(--focus-ring)}
    .segmented{display:flex;background:#f1f5f9;border:1px solid var(--border);border-radius:999px;padding:6px;gap:6px;align-items:center;flex-wrap:wrap}
    .seg{position:relative;display:flex;align-items:center;gap:.55rem;padding:.52rem .9rem;border-radius:999px;background:transparent;border:1px solid transparent;color:#0f172a;font-weight:700;cursor:pointer;transition:.18s ease}
    .seg[data-active="true"]{background:#fff;border-color:var(--border);box-shadow:var(--shadow);transform:translateY(-1px)}
    .seg .dot{width:10px;height:10px;border-radius:50%}
    .seg.crypto .dot{background:var(--crypto)}
    .seg.card .dot{background:var(--card)}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{padding:.45rem .65rem;border-radius:999px;background:var(--chip);border:1px solid var(--border);cursor:pointer;font-weight:700;font-size:.85rem}
    .chip:hover{box-shadow:var(--shadow)}
    .meta-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-flex;align-items:center;gap:.4rem;font-weight:800;padding:.35rem .6rem;border-radius:999px;border:1px solid}
    .badge.cents{background:#ecfeff;border-color:#a5f3fc;color:#155e75}
    .badge.crypto{background:#ecfdf5;border-color:#bbf7d0;color:var(--crypto-ink)}
    .badge.card{background:#fff7ed;border-color:#fed7aa;color:var(--card-ink)}
    .actions{display:flex;gap:12px;flex-wrap:wrap;border-top:1px dashed var(--border);padding-top:14px}
    .message{padding:12px 14px;border-radius:10px;border:1px solid;margin-top:2px}
    .message.error{background:var(--error-bg);border-color:var(--error-border);color:#991b1b}
    .message.success{background:var(--success-bg);border-color:var(--success-border);color:#065f46}
    /* URL Card */
    .url-wrap{display:none}
    .url-wrap.show{display:block;animation:fadeIn .18s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    .url-card{border:1px solid var(--border);border-radius:var(--rounded-2xl);box-shadow:var(--shadow-lg);overflow:hidden;background:#fff}
    .url-head{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border)}
    .url-head .left{display:flex;align-items:center;gap:10px}
    .pill{display:inline-flex;align-items:center;gap:.45rem;padding:.35rem .6rem;border-radius:999px;font-weight:800;font-size:.8rem}
    .pill.crypto{background:#ecfdf5;color:var(--crypto-ink);border:1px solid #bbf7d0}
    .pill.card{background:#fff7ed;color:var(--card-ink);border:1px solid #fed7aa}
    .url-body{padding:14px 16px;display:grid;gap:10px}
    .mono{font-family:var(--mono);font-size:.95rem;background:#0b1220;color:#e2e8f0;padding:12px 12px;border-radius:10px;border:1px solid #132036;overflow:auto;word-break:break-all}
    .url-actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn.ghost{background:#0b1220;color:#e2e8f0;border-color:#122038}
    .btn.minor{background:#f8fafc}
    .footer-hint{color:var(--muted);font-size:.8rem;margin-top:6px}
    /* Mobile tweaks */
    @media (max-width:640px){
      .header-content{flex-direction:column;align-items:stretch}
      .brand{justify-content:center}
      .btn{justify-content:center}
    }
  </style>
</head>
<body>
  <!-- Session check -->
  <script>
    (async () => {
      try {
        const r = await fetch('/api/admin/session', { credentials: 'include' });
        if (!r.ok || !(await r.json()).ok) location.replace('/admin.html');
      } catch { location.replace('/admin.html'); }
    })();
  </script>

  <header class="header">
    <div class="header-content">
      <div class="brand">
        <div class="brand-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M12 3v18"/>
          </svg>
        </div>
        Generate Payment Link
      </div>
      <div class="header-actions">
        <a class="btn" href="/admin/panel/index.html">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <rect x="3" y="3" width="7" height="9"/>
            <rect x="14" y="3" width="7" height="5"/>
            <rect x="14" y="12" width="7" height="9"/>
            <rect x="3" y="16" width="7" height="5"/>
          </svg>
          Dashboard
        </a>
        <button id="logoutBtn" class="btn primary" type="button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16,17 21,12 16,7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
          Sign Out
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="page-header">
      <h1 class="page-title">Create a Payment URL</h1>
      <p class="page-description">Build a shareable link for **Crypto** or **Credit Card**. Price is converted to cents (<code>15.99 → 1599</code>) for the <code>id</code> query param.</p>
    </div>

    <div class="card">
      <form id="payLinkForm" class="form" novalidate>
        <div class="form-row two">
          <div class="form-group">
            <label class="form-label" for="email">Client Email<span class="required">*</span></label>
            <input id="email" class="input" type="email" placeholder="user@example.com" required />
            <div class="hint">Included in the credit-card URL.</div>
          </div>
          <div class="form-group">
            <label class="form-label" for="price">Price (USD)<span class="required">*</span></label>
            <input id="price" class="input" type="text" inputmode="decimal" placeholder="e.g., 15.99" required />
            <div class="meta-row">
              <span class="badge cents" id="centsBadge">id: —</span>
              <div class="chips" aria-label="Quick amounts">
                <span class="chip" data-amt="9.99">$9.99</span>
                <span class="chip" data-amt="15.99">$15.99</span>
                <span class="chip" data-amt="29.99">$29.99</span>
                <span class="chip" data-amt="49">$49.00</span>
              </div>
            </div>
            <div class="hint">You can type <code>15,99</code> or <code>$15.99</code>; we’ll handle it.</div>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Payment Method<span class="required">*</span></label>
          <div class="segmented" id="methodSeg">
            <input hidden id="m-crypto" name="method" type="radio" value="crypto">
            <label class="seg crypto" for="m-crypto" data-method="crypto">
              <span class="dot"></span> Crypto
            </label>
            <input hidden id="m-card" name="method" type="radio" value="card" checked>
            <label class="seg card" for="m-card" data-method="card">
              <span class="dot"></span> Credit Card
            </label>
          </div>
          <div class="meta-row">
            <span class="badge crypto" id="cryptoHint">Crypto URL pattern: /crypto?id=1599</span>
            <span class="badge card" id="cardHint">Card URL pattern: /pay?email=...&id=1599</span>
          </div>
        </div>

        <div id="messageContainer" aria-live="polite"></div>

        <div class="actions">
          <button id="generateBtn" class="btn primary" type="submit">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M12 5v14m-7-7h14"/>
            </svg>
            <span>Generate Link</span>
          </button>
          <button id="resetBtn" class="btn" type="button">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M4.05 11a8 8 0 1 1 1.9 5.1M4 4v7h7"/>
            </svg>
            <span>Reset</span>
          </button>
        </div>

        <!-- URL Result -->
        <div id="urlSection" class="url-wrap" aria-live="polite">
          <div class="url-card">
            <div class="url-head">
              <div class="left">
                <span id="methodPill" class="pill card">Credit Card</span>
                <span class="hint" id="urlNote">Share this link with the client.</span>
              </div>
              <div class="right meta-row">
                <span class="badge cents" id="finalCents">id: —</span>
              </div>
            </div>
            <div class="url-body">
              <div id="urlMono" class="mono">—</div>
              <div class="url-actions">
                <button id="copyBtn" class="btn ghost" type="button">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                  </svg>
                  <span>Copy</span>
                </button>
                <a id="openBtn" class="btn minor" target="_blank" rel="noopener">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <path d="M18 3h3v3M21 3l-7 7"/>
                    <path d="M14 3H6a3 3 0 0 0-3 3v12a3 3 0 0 0 3 3h12a3 3 0 0 0 3-3v-8"/>
                  </svg>
                  <span>Open</span>
                </a>
              </div>
              <div class="footer-hint">Crypto: <code>https://app.trendmysong.com/crypto?id=1599</code> · Card: <code>https://app.trendmysong.com/pay?email=...&id=1599</code></div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </main>

  <script>
    // Elements
    const form = document.getElementById('payLinkForm');
    const emailEl = document.getElementById('email');
    const priceEl = document.getElementById('price');
    const centsBadge = document.getElementById('centsBadge');
    const chips = Array.from(document.querySelectorAll('.chip'));
    const segWrap = document.getElementById('methodSeg');
    const methodLabels = Array.from(segWrap.querySelectorAll('.seg'));
    const messageContainer = document.getElementById('messageContainer');
    const urlSection = document.getElementById('urlSection');
    const methodPill = document.getElementById('methodPill');
    const urlMono = document.getElementById('urlMono');
    const openBtn = document.getElementById('openBtn');
    const copyBtn = document.getElementById('copyBtn');
    const finalCents = document.getElementById('finalCents');
    const resetBtn = document.getElementById('resetBtn');

    // Helpers
    const validEmail = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    const showMsg = (t, type) => messageContainer.innerHTML = `<div class="message ${type}">${t}</div>`;
    const clearMsg = () => messageContainer.innerHTML = '';

    function priceToCents(input){
      if(!input) return NaN;
      const cleaned = String(input).trim().replace(/[$\s,]/g,'').replace(',', '.');
      const n = parseFloat(cleaned);
      if (isNaN(n) || n <= 0) return NaN;
      return Math.round(n * 100);
    }

    function getMethod(){
      const checked = segWrap.querySelector('input[name="method"]:checked');
      return checked ? checked.value : 'card';
    }

    function buildUrl(email, cents, method){
      if (method === 'crypto') return `https://app.trendmysong.com/crypto?id=${cents}`;
      return `https://app.trendmysong.com/pay?email=${encodeURIComponent(email.trim())}&id=${cents}`;
    }

    function setSegActive(method){
      methodLabels.forEach(l => l.dataset.active = (l.dataset.method === method));
      methodPill.textContent = method === 'crypto' ? 'Crypto' : 'Credit Card';
      methodPill.className = `pill ${method === 'crypto' ? 'crypto' : 'card'}`;
    }

    function updateCentsPreview(){
      const cents = priceToCents(priceEl.value);
      centsBadge.textContent = 'id: ' + (isNaN(cents) ? '—' : cents);
      finalCents.textContent = centsBadge.textContent;
    }

    // Events
    segWrap.addEventListener('click', (e) => {
      const lab = e.target.closest('.seg');
      if(!lab) return;
      segWrap.querySelector(`#m-${lab.dataset.method}`).checked = true;
      setSegActive(lab.dataset.method);
    });

    chips.forEach(ch => ch.addEventListener('click', () => {
      priceEl.value = Number(ch.dataset.amt).toFixed(2);
      updateCentsPreview();
      priceEl.focus();
    }));

    priceEl.addEventListener('input', updateCentsPreview);
    priceEl.addEventListener('blur', () => {
      const cleaned = String(priceEl.value).trim().replace(/[$\s,]/g,'').replace(',', '.');
      const n = parseFloat(cleaned);
      if (!isNaN(n) && n > 0) priceEl.value = n.toFixed(2);
      updateCentsPreview();
    });
    updateCentsPreview();
    setSegActive(getMethod());

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      clearMsg();

      const email = emailEl.value.trim();
      const cents = priceToCents(priceEl.value);
      const method = getMethod();

      if (!email || !validEmail(email)) {
        return showMsg('Please enter a valid email address.', 'error');
      }
      if (isNaN(cents)) {
        return showMsg('Please enter a valid price (e.g., 15.99).', 'error');
      }

      const url = buildUrl(email, cents, method);

      urlMono.textContent = url;
      openBtn.href = url;
      urlSection.classList.add('show');
      finalCents.textContent = 'id: ' + cents;

      showMsg('Link generated successfully.', 'success');
      // Scroll URL into view on mobile
      urlSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });

    copyBtn.addEventListener('click', async () => {
      try{
        await navigator.clipboard.writeText(urlMono.textContent);
        const span = copyBtn.querySelector('span');
        const old = span.textContent;
        span.textContent = 'Copied!';
        setTimeout(() => span.textContent = old, 1200);
      }catch{
        showMsg('Unable to copy. Select and copy the URL manually.', 'error');
      }
    });

    resetBtn.addEventListener('click', () => {
      form.reset();
      setSegActive('card');
      urlSection.classList.remove('show');
      updateCentsPreview();
      clearMsg();
      emailEl.focus();
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try { await fetch('/api/admin/logout', { method:'POST', credentials:'include' }); } catch(_){}
      location.replace('/admin.html');
    });
  </script>
</body>
</html>
