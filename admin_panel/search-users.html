<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Search Users — Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <style>
    :root{
      --bg:#f5f7fb;--surface:#fff;--ink:#0f172a;--muted:#64748b;--border:#e5e7eb;
      --primary:#2563eb;--primary-2:#1d4ed8;--ring:0 0 0 3px rgba(37,99,235,.14);
      --good:#10b981;--good-bg:#ecfdf5;--good-br:#a7f3d0;
      --shadow:0 1px 2px rgba(0,0,0,.05),0 6px 20px rgba(0,0,0,.06);
      --radius:12px; --radius-sm:10px; --sticky:74px;
      --fs-14:14.5px; --fs-15:15.5px;
      --table-head:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{
      margin:0;background:var(--bg);color:var(--ink);
      font:400 var(--fs-15)/1.5 arial;
      min-height:100vh;display:flex;flex-direction:column
    }

    /* Header */
    .header{background:var(--surface);border-bottom:1px solid var(--border);box-shadow:var(--shadow);position:sticky;top:0;z-index:10}
    .header-inner{max-width:1280px;margin:0 auto;padding:16px 20px;display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px;font-weight:400}
    .badge{padding:2px 10px;border-radius:999px;background:#e0e7ff;color:#1e40af;font-size:12px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:9px 13px;border:1px solid var(--border);border-radius:10px;background:var(--surface);font-weight:600;color:var(--ink);text-decoration:none;cursor:pointer}
    .btn:hover{background:#f8fafc}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover{background:var(--primary-2)}
    .icon{width:18px;height:18px}

    /* Page */
    .wrap{max-width:1280px;margin:0 auto;padding:22px 20px;flex:1}
    .toprow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:14px}
    .title{font-size:22px;font-weight:400;margin:0}
    .pill{font-size:13px;color:var(--muted)}

    /* Card */
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card-body{padding:14px}

    /* Tabs */
    .tabs{display:flex;gap:6px;border-bottom:1px solid var(--border);padding:0 8px}
    .tab{
      appearance:none;border:0;background:transparent;padding:10px 12px;border-radius:10px 10px 0 0;
      font-weight:700;color:#1f2937;cursor:pointer;position:relative;top:1px
    }
    .tab[aria-selected="true"]{
      background:var(--surface);border:1px solid var(--border);border-bottom-color:var(--surface)
    }
    .panels{padding:14px 10px}
    .panel{display:none}
    .panel.active{display:block}

    /* Inputs (organized grid) */
    .grid{display:grid;gap:10px}
    .grid.cols-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(max-width:1100px){ .grid.cols-4{grid-template-columns:repeat(3,1fr)} }
    @media(max-width:900px){ .grid.cols-3,.grid.cols-4{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:560px){ .grid.cols-2,.grid.cols-3,.grid.cols-4{grid-template-columns:1fr} }

    .input,.select{
      padding:9px 11px;border:1px solid var(--border);border-radius:10px;background:#fff;color:var(--ink);
      font-size:var(--fs-14);height:38px
    }
    .input:focus,.select:focus{outline:none;box-shadow:var(--ring);border-color:#c7d2fe}
    .toolbar-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-left:auto}

    .msg{margin:10px 0;padding:10px 12px;border:1px solid #fecaca;background:#fee2e2;color:#991b1b;border-radius:10px;display:none}

    /* TABLE – FIXED LAYOUT + FIXED COL WIDTHS */
    .table-outer{border-top:1px solid var(--border)}
    .table-wrap{
      overflow:auto;            /* horizontal + vertical scroll if needed */
      max-height:calc(100vh - 320px);
      background:#fff;
      border-top-left-radius:12px;border-top-right-radius:12px
    }
    table{width:100%;border-collapse:collapse;table-layout:fixed} /* <= fixed layout */
    /* Fixed widths per column */
    colgroup col:nth-child(1){width:140px}  /* User ID */
    colgroup col:nth-child(2){width:220px}  /* Email */
    colgroup col:nth-child(3){width:110px}  /* Paid */
    colgroup col:nth-child(4){width:120px}  /* Plan */
    colgroup col:nth-child(5){width:150px}  /* Platform */
    colgroup col:nth-child(6){width:120px}  /* Date */
    colgroup col:nth-child(7){width:120px}  /* Status */
    colgroup col:nth-child(8){width:200px}  /* Services */

    thead th{
      position:sticky;top:0;background:var(--table-head);border-bottom:1px solid var(--border);
      font-size:13px;font-weight:600;color:#0f172a;padding:9px 10px;text-align:left;user-select:none;cursor:pointer;
      z-index:1
    }
    tbody td{
      padding:9px 10px;border-bottom:1px solid var(--border);font-size:var(--fs-14);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis
    }
    tbody tr:hover{background:#fafafa}
    .align-r{text-align:right}

    /* Status pill (desktop default) */
    .status{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}
    .status.active{background:var(--good-bg);border-color:var(--good-br);color:#065f46}
    .status.inactive{background:#f1f5f9;color:#334155}

    .meta{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;color:var(--muted);font-size:13px;border-top:1px solid var(--border)}

    /* Desktop vs Mobile */
    .desktop-only{display:none}
    .mobile-only{display:grid;gap:8px}
    @media(min-width:900px){ .desktop-only{display:block} .mobile-only{display:none} }

    /* MOBILE CARDS — compact + neutral status */
    @media(max-width:899.98px){
      .mcard{border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff;display:grid;gap:6px}
      .mrow{display:flex;justify-content:space-between;gap:10px}
      .muted{color:var(--muted);font-size:12px}
      .tag{display:inline-block;padding:1px 6px;border-radius:999px;background:#f3f4f6;color:#111827;font-size:11px}
      .status{background:#f3f4f6 !important;border-color:#e5e7eb !important;color:#111827 !important} /* neutralize "active" */
    }
    .spinner{width:18px;height:18px;border:2px solid rgba(0,0,0,.15);border-top:2px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- Session check -->
  <script>
    (async()=>{try{const r=await fetch('/api/admin/session',{credentials:'include'});if(!r.ok||!(await r.json()).ok)location.replace('/admin.html')}catch{location.replace('/admin.html')}})();
  </script>

  <header class="header">
    <div class="header-inner">
      <div class="brand">
        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/>
          <line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/>
        </svg>
        <strong>Search Users</strong>
      </div>
      <div>
        <a class="btn" href="/admin/panel/index.html">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/>
            <rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/>
          </svg> Dashboard
        </a>
        <button id="logoutBtn" class="btn primary" type="button">
          <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16,17 21,12 16,7"/><line x1="21" y1="12" x2="9" y2="12"/>
          </svg> Sign Out
        </button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="toprow">
      <h1 class="title">All Users</h1>
    </div>

    <div class="card">
      <div class="card-body">

        <!-- Tabs -->
        <div class="tabs" role="tablist" aria-label="Filters">
          <button class="tab" role="tab" aria-selected="true" aria-controls="panel-quick" id="tab-quick">Quick Search</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="panel-filters" id="tab-filters">Filters</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="panel-date" id="tab-date">Date & Amount</button>
          <div class="toolbar-actions">
            <button id="exportCsv" class="btn" type="button" title="Export filtered rows">
              <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg> Export CSV
            </button>
            <div id="loading" class="spinner" style="display:none"></div>
          </div>
        </div>

        <div class="panels">
          <!-- Panel: Quick Search -->
          <section id="panel-quick" class="panel active" role="tabpanel" aria-labelledby="tab-quick">
            <div class="grid cols-2">
              <input id="q" class="input" type="search" placeholder="Search all fields…" />
              <input id="fServices" class="input" placeholder='Services (e.g., "YT SM")' />
            </div>
          </section>

          <!-- Panel: Filters -->
          <section id="panel-filters" class="panel" role="tabpanel" aria-labelledby="tab-filters">
            <div class="grid cols-3">
              <input id="fUser" class="input" placeholder="User ID" />
              <input id="fEmail" class="input" placeholder="Email" />
              <input id="fPlatform" class="input" placeholder="Payment Platform (Gumroad, PayPal…)" />
              <input id="fStatus" class="input" placeholder="Status (active, paused…)" />
              <input id="fPlan" class="input" placeholder="Plan" />
            </div>
          </section>

          <!-- Panel: Date & Amount -->
          <section id="panel-date" class="panel" role="tabpanel" aria-labelledby="tab-date">
            <div class="grid cols-4">
              <input id="minPaid" class="input" type="number" step="0.01" placeholder="Min $" />
              <input id="maxPaid" class="input" type="number" step="0.01" placeholder="Max $" />
              <input id="dateFrom" class="input" type="date" />
              <input id="dateTo" class="input" type="date" />
            </div>
          </section>
        </div>

        <div id="msg" class="msg"></div>

        <!-- Desktop table (fixed layout & widths) -->
        <div class="table-outer desktop-only">
          <div class="table-wrap" id="tableWrap">
            <table id="t">
              <colgroup>
                <col /><col /><col /><col /><col /><col /><col /><col />
              </colgroup>
              <thead>
                <tr>
                  <th data-key="User ID">User ID</th>
                  <th data-key="Email">Email</th>
                  <th data-key="Paid Amount" class="align-r">Paid</th>
                  <th data-key="Plan">Plan</th>
                  <th data-key="Payment Platform">Platform</th>
                  <th data-key="Date">Date</th>
                  <th data-key="Account Status">Status</th>
                  <th data-key="services">Services</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Mobile cards (compact + neutral status) -->
        <div class="mobile-only" id="cards"></div>

        <div class="meta">
          <div><strong id="rowCount">0</strong> Users</div>
          <div id="lastUpdated"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Sign out
    document.addEventListener('click', async (e)=>{
      if(e.target.closest('#logoutBtn')){
        try{await fetch('/api/admin/logout',{method:'POST',credentials:'include'})}catch{}
        location.replace('/admin.html')
      }
    });

    // Tabs
    const tabs=[...document.querySelectorAll('.tab')];
    const panels=[...document.querySelectorAll('.panel')];
    tabs.forEach(t=>{
      t.addEventListener('click',()=>{
        tabs.forEach(x=>x.setAttribute('aria-selected','false'));
        panels.forEach(p=>p.classList.remove('active'));
        t.setAttribute('aria-selected','true');
        document.getElementById(t.getAttribute('aria-controls')).classList.add('active');
      });
    });

    // Utils
    const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
    const debounce=(fn,ms=220)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}};
    const asNumber=v=>{const n=parseFloat(v);return isNaN(n)?null:n};

    // Sheets serial → Date
    function fromSerial(n){const epoch=Date.UTC(1899,11,30);return new Date(epoch+n*86400000)}
    function parseDate(val){
      if(val==null||val==='') return null;
      if(typeof val==='number') return fromSerial(val);
      if(/^\d{4}-\d{2}-\d{2}$/.test(String(val))) return new Date(String(val)+'T00:00:00Z');
      const d=new Date(val); return isNaN(d)?null:d;
    }
    function fmtDate(val){
      const d=parseDate(val); if(!d) return '—';
      const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,'0'), da=String(d.getUTCDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function ts(val){const d=parseDate(val); return d?d.getTime():-Infinity}
    function fmtMoney(v){
      const n=asNumber(v); if(n===null) return '—';
      try{return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2}).format(n)}
      catch{return '$'+n.toFixed(2)}
    }
    function servicesMatch(cell, query){
      const q=String(query||'').trim(); if(!q) return true;
      const tokens=q.split(/\s+/).filter(Boolean).map(s=>s.toUpperCase());
      const src=String(cell||'').toUpperCase();
      return tokens.every(t=>src.includes(t));
    }
    function includes(a,b){return String(a||'').toLowerCase().includes(String(b||'').toLowerCase().trim())}

    // State
    let raw=[], view=[], sortKey=null, sortDir=1;

    const tableBody=$('#t tbody');
    const cards=$('#cards');
    const rowCount=$('#rowCount');
    const lastUpdated=$('#lastUpdated');
    const loading=$('#loading');
    const msg=$('#msg');
    const summary=$('#summary');

    function renderTable(){
      tableBody.innerHTML='';
      for(const r of view){
        const tr=document.createElement('tr');
        const td=t=>{const d=document.createElement('td'); d.textContent=t??'—'; return d}
        const tdR=t=>{const d=td(t); d.classList.add('align-r'); return d}
        tr.appendChild(td(r['User ID']));
        tr.appendChild(td(r['Email']));
        tr.appendChild(tdR(fmtMoney(r['Paid Amount'])));
        tr.appendChild(td(r['Plan']||'—'));
        tr.appendChild(td(r['Payment Platform']||'—'));
        tr.appendChild(td(fmtDate(r['Date'])));
        const st=document.createElement('td');
        const s=document.createElement('span');
        const isActive=String(r['Account Status']||'').toLowerCase().includes('active');
        s.className='status '+(isActive?'active':'inactive');
        s.textContent=r['Account Status']||'—';
        st.appendChild(s); tr.appendChild(st);
        tr.appendChild(td(r['services']||'—'));
        tableBody.appendChild(tr);
      }
    }
    function renderCards(){
      cards.innerHTML='';
      for(const r of view){
        const card=document.createElement('div'); card.className='mcard';
        const head=document.createElement('div'); head.className='mrow';
        const left=document.createElement('div'); left.innerHTML=`<strong>${r['User ID']||'—'}</strong><div class="muted">${r['Email']||'—'}</div>`;
        const status=document.createElement('span');
        status.className='status'; /* neutral in mobile via CSS */
        status.textContent=r['Account Status']||'—';
        head.append(left,status);

        const row1=document.createElement('div'); row1.className='mrow';
        row1.innerHTML=`<span class="muted">Paid</span><strong>${fmtMoney(r['Paid Amount'])}</strong>`;

        const row2=document.createElement('div'); row2.className='mrow';
        row2.innerHTML=`<span class="muted">Plan • Platform</span><span><span class="tag">${r['Plan']||'—'}</span> &nbsp; ${r['Payment Platform']||'—'}</span>`;

        const row3=document.createElement('div'); row3.className='mrow';
        row3.innerHTML=`<span class="muted">Date</span><span>${fmtDate(r['Date'])}</span>`;

        const row4=document.createElement('div'); row4.className='mrow';
        row4.innerHTML=`<span class="muted">Services</span><span>${r['services']||'—'}</span>`;

        card.append(head,row1,row2,row3,row4);
        cards.appendChild(card);
      }
    }
    function renderAll(){
      renderTable(); renderCards();
      rowCount.textContent=String(view.length);
      lastUpdated.textContent='Updated: '+new Date().toLocaleString();
    }

    function applyFilters(){
      const q=$('#q').value, fUser=$('#fUser').value, fEmail=$('#fEmail').value, fPlatform=$('#fPlatform').value;
      const fStatus=$('#fStatus').value, fServices=$('#fServices').value, fPlan=$('#fPlan').value;
      const minPaid=asNumber($('#minPaid').value), maxPaid=asNumber($('#maxPaid').value);
      const dFrom=$('#dateFrom').value?new Date($('#dateFrom').value+'T00:00:00Z'):null;
      const dTo=$('#dateTo').value?new Date($('#dateTo').value+'T23:59:59Z'):null;

      const hasQ=String(q||'').trim().length>0;

      view = raw.filter(r=>{
        if(hasQ){
          const all=[r['User ID'],r['Email'],r['Paid Amount'],r['Plan'],r['Payment Platform'],r['Date'],r['Account Status'],r['services']]
            .map(x=>String(x??'')).join(' ');
          if(!includes(all,q)) return false;
        }
        if(fUser && !includes(r['User ID'],fUser)) return false;
        if(fEmail && !includes(r['Email'],fEmail)) return false;
        if(fPlatform && !includes(r['Payment Platform'],fPlatform)) return false;
        if(fStatus && !includes(r['Account Status'],fStatus)) return false;
        if(fPlan && !includes(r['Plan'],fPlan)) return false;
        if(!servicesMatch(r['services'],fServices)) return false;

        const paid=asNumber(r['Paid Amount']);
        if(minPaid!==null && (paid===null || paid<minPaid)) return false;
        if(maxPaid!==null && (paid===null || paid>maxPaid)) return false;

        if(dFrom || dTo){
          const t=ts(r['Date']); if(t===-Infinity) return false;
          if(dFrom && t<dFrom.getTime()) return false;
          if(dTo && t>dTo.getTime()) return false;
        }
        return true;
      });

      if(sortKey){
        view.sort((a,b)=>{
          const va=a[sortKey], vb=b[sortKey];
          if(sortKey==='Paid Amount'){return sortDir*((asNumber(va)||0)-(asNumber(vb)||0))}
          if(sortKey==='Date'){return sortDir*(ts(va)-ts(vb))}
          return sortDir*String(va??'').localeCompare(String(vb??''),undefined,{sensitivity:'base'});
        });
      }

      renderAll();
    }

    function attachSorting(){
      $$('#t thead th').forEach(th=>{
        th.addEventListener('click',()=>{
          const key=th.getAttribute('data-key'); if(!key) return;
          if(sortKey===key){ sortDir*=-1 } else { sortKey=key; sortDir=1 }
          applyFilters();
        });
      });
    }

    function toCsv(rows){
      const headers=['User ID','Email','Paid Amount','Plan','Payment Platform','Date','Account Status','services'];
      const esc=v=>{const s=String(v??'');return (s.includes('"')||s.includes(',')||s.includes('\n'))?('"'+s.replace(/"/g,'""')+'"'):s};
      const lines=[headers.join(',')];
      rows.forEach(r=>{
        lines.push([
          esc(r['User ID']),esc(r['Email']),
          esc(asNumber(r['Paid Amount'])!=null?asNumber(r['Paid Amount']).toFixed(2):''),
          esc(r['Plan']),esc(r['Payment Platform']),
          esc(fmtDate(r['Date'])),esc(r['Account Status']),esc(r['services'])
        ].join(','));
      });
      return lines.join('\n');
    }

    document.getElementById('exportCsv').addEventListener('click',()=>{
      const csv=toCsv(view);
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='reports_export.csv';
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    const debounced=debounce(applyFilters,220);
    ['#q','#fServices','#fUser','#fEmail','#fPlatform','#fStatus','#fPlan','#minPaid','#maxPaid','#dateFrom','#dateTo']
      .forEach(sel=>document.querySelector(sel).addEventListener('input',debounced));

    attachSorting();

    async function load(){
      const loadingEl=document.getElementById('loading'); const msgEl=document.getElementById('msg');
      loadingEl.style.display='inline-block'; msgEl.style.display='none';
      try{
        const r=await fetch('/reports',{cache:'no-store'});
        if(!r.ok) throw new Error('Failed /reports');
        const j=await r.json();
        raw=Array.isArray(j.data)?j.data:[];
        applyFilters();
      }catch(e){
        console.error(e);
        msgEl.textContent='Error loading reports. Please try again.'; msgEl.style.display='block';
      }finally{
        loadingEl.style.display='none';
      }
    }
    load();
  </script>
</body>
</html>
