<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Block User — Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <style>
    :root{
      --bg:#f8fafc;--surface:#ffffff;--text:#1e293b;--muted:#64748b;--border:#e2e8f0;
      --primary:#3b82f6;--primary-hover:#2563eb;
      --warn:#f59e0b;--warn-hover:#d97706; /* amber for "block" */
      --success:#10b981;--success-bg:#d1fae5;--success-border:#a7f3d0;
      --error:#ef4444;--error-bg:#fee2e2;--error-border:#fecaca;
      --shadow:0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06);
      --shadow-lg:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06);
      --radius:8px;--focus-ring:0 0 0 3px rgba(59,130,246,.1);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh;display:flex;flex-direction:column}
    .header{background:var(--surface);border-bottom:1px solid var(--border);padding:1rem;box-shadow:var(--shadow)}
    .header-content{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:1rem}
    .brand{display:flex;align-items:center;gap:.75rem;font-weight:700;font-size:1.25rem}
    .brand-icon{width:32px;height:32px;background:linear-gradient(135deg,var(--primary),var(--primary-hover));border-radius:var(--radius);display:flex;align-items:center;justify-content:center;color:#fff}
    .header-actions{display:flex;gap:.5rem;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:.5rem;padding:.625rem 1rem;border:1px solid var(--border);border-radius:var(--radius);background:var(--surface);color:var(--text);text-decoration:none;font-weight:500;font-size:.875rem;cursor:pointer;transition:all .15s ease}
    .btn:hover{background:#f8fafc;border-color:#cbd5e1}
    .btn:focus-visible{outline:none;box-shadow:var(--focus-ring)}
    .btn.primary{background:var(--primary);border-color:var(--primary);color:#fff}
    .btn.primary:hover:not(:disabled){background:var(--primary-hover);border-color:var(--primary-hover)}
    .btn.warn{background:var(--warn);border-color:var(--warn);color:#111827}
    .btn.warn:hover:not(:disabled){background:var(--warn-hover);border-color:var(--warn-hover)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .container{max-width:900px;margin:0 auto;padding:2rem 1rem;flex:1}
    .page-header{margin-bottom:2rem}
    .page-title{font-size:2rem;font-weight:700;margin:0 0 .5rem}
    .page-description{color:var(--muted);margin:0}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:2rem;box-shadow:var(--shadow)}
    .form{display:grid;gap:1.25rem}
    .form-row{display:grid;gap:1rem;grid-template-columns:1fr}
    @media (min-width:768px){.form-row.two-columns{grid-template-columns:1fr 1fr}}
    .form-group{display:flex;flex-direction:column}
    .form-label{font-weight:600;font-size:.875rem;margin-bottom:.5rem}
    .required{color:var(--error);margin-left:2px}
    .form-input,.form-select,.form-textarea{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:var(--radius);background:var(--surface);color:var(--text);font-size:.875rem;transition:all .15s ease}
    .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:var(--focus-ring)}
    .form-textarea{min-height:110px;resize:vertical}
    .form-hint{color:var(--muted);font-size:.75rem;margin-top:.5rem;line-height:1.4}
    .form-actions{display:flex;gap:1rem;flex-wrap:wrap;padding-top:1rem;border-top:1px solid var(--border)}
    .message{padding:1rem;border-radius:var(--radius);border:1px solid;font-size:.875rem;margin:1rem 0}
    .message.success{background:var(--success-bg);border-color:var(--success-border);color:#065f46}
    .message.error{background:var(--error-bg);border-color:var(--error-border);color:#991b1b}
    .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top:2px solid white;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.5);display:none;align-items:center;justify-content:center;padding:1rem;z-index:50}
    .modal-backdrop.show{display:flex}
    .modal{width:100%;max-width:560px;background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow-lg);padding:1.25rem}
    .modal header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem}
    .modal-title{font-weight:700;font-size:1.125rem;margin:0}
    .modal-body{display:grid;gap:1rem;padding-top:.5rem}
    .modal-actions{display:flex;gap:.75rem;justify-content:flex-end;padding-top:1rem;border-top:1px solid var(--border)}
    .close-x{background:transparent;border:none;font-size:1.25rem;line-height:1;cursor:pointer;color:var(--muted)}
    @media (max-width:640px){
      .container{padding:1rem}
      .card{padding:1.5rem}
      .header-content{flex-direction:column;align-items:stretch}
      .header-actions{justify-content:center}
      .brand{justify-content:center}
      .form-actions{flex-direction:column}
      .btn{justify-content:center}
    }
  </style>
</head>
<body>
  <!-- Session check -->
  <script>
    (async () => {
      try {
        const r = await fetch('/api/admin/session', { credentials: 'include' });
        if (!r.ok || !(await r.json()).ok) location.replace('/admin.html');
      } catch { location.replace('/admin.html'); }
    })();
  </script>

  <header class="header">
    <div class="header-content">
      <div class="brand">
        <div class="brand-icon" aria-hidden="true">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M12 3v18" />
          </svg>
        </div>
        <span>Block User</span>
      </div>
      <div class="header-actions">
        <a class="btn" href="/admin/panel/index.html">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="9"/>
            <rect x="14" y="3" width="7" height="5"/>
            <rect x="14" y="12" width="7" height="9"/>
            <rect x="3" y="16" width="7" height="5"/>
          </svg>
          Dashboard
        </a>
        <button id="logoutBtn" class="btn primary" type="button">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16,17 21,12 16,7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
          Sign Out
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="page-header">
      <h1 class="page-title">Block Existing User</h1>
      <p class="page-description">Temporarily block a user’s access. This action is reversible by an admin.</p>
      <p><strong>Read Before Submitting</strong></p>
      <p class="page-description"><strong>Important:</strong> Blocking a user affects their access to upload any tracks.</p>
      <p class="page-description">All block actions are automatically reported to the administration.</p>
      <p class="page-description">Always verify user details beforehand.</p>
      <p class="page-description">
        You can retrieve the <strong>User ID</strong> and double-check the associated <strong>email addresses</strong> by opening the
        <a href="https://app.trendmysong.com/admin/panel/search-users">Search User Panel</a>.
      </p>
    </div>

    <div class="card">
      <form id="blockUserForm" class="form" novalidate>
        <div class="form-row two-columns">
          <div class="form-group">
            <label class="form-label" for="userId">User ID<span class="required">*</span></label>
            <input id="userId" class="form-input" type="text" placeholder="e.g., TM1234567" required />
            <div class="form-hint">Enter the exact User ID.</div>
          </div>
          <div class="form-group">
            <label class="form-label" for="email">Email Address<span class="required">*</span></label>
            <input id="email" class="form-input" type="email" placeholder="user@example.com" required />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label" for="reason">Reason for Blocking<span class="required">*</span></label>
          <textarea id="reason" class="form-textarea" placeholder="Provide a clear reason that can be shared with the client." required></textarea>
          <div class="form-hint">Be specific and factual. This may be included in the client notification.</div>
        </div>

        <div id="messageContainer"></div>

        <div class="form-actions">
          <button id="submitBtn" class="btn warn" type="submit">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
              <path d="M12 9v4m0 4h.01" />
              <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            </svg>
            <span>Block User</span>
          </button>
          <a class="btn" href="/admin/panel/index.html">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5m7-7l-7 7 7 7"/>
            </svg>
            Cancel
          </a>
        </div>
      </form>
    </div>
  </main>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="confirmTitle" aria-hidden="true">
    <div class="modal">
      <header>
        <h2 id="confirmTitle" class="modal-title">Confirm Block Action</h2>
        <button type="button" class="close-x" id="closeModalBtn" aria-label="Close">&times;</button>
      </header>
      <div class="modal-body">
        <p class="page-description"><strong>Note:</strong> You <u>must</u> contact the client and inform the reason for blocking.</p>
        <div class="card" style="padding:1rem;border-radius:10px">
          <div style="font-size:.875rem;color:var(--muted);margin-bottom:.5rem;">You are about to block:</div>
          <div id="reviewDetails" style="font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:.9rem"></div>
        </div>
        <div id="modalMessage"></div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn" id="cancelConfirmBtn">Cancel</button>
        <button type="button" class="btn warn" id="confirmBlockBtn">
          <span>Confirm & Block</span>
        </button>
      </div>
    </div>
  </div>

  <script>
    // ===== Config =====

    // ===== Elements =====
    const messageContainer = document.getElementById('messageContainer');
    const submitBtn = document.getElementById('submitBtn');
    const submitBtnText = submitBtn.querySelector('span');
    const submitBtnIcon = submitBtn.querySelector('svg');

    const confirmModal = document.getElementById('confirmModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
    const confirmBlockBtn = document.getElementById('confirmBlockBtn');
    const reviewDetails = document.getElementById('reviewDetails');
    const modalMessage = document.getElementById('modalMessage');

    function setLoading(loading){
      if(loading){
        submitBtn.disabled = true;
        submitBtnIcon.style.display = 'none';
        submitBtnText.textContent = 'Submitting...';
        const spinner = document.createElement('div');
        spinner.className = 'spinner';
        spinner.setAttribute('aria-hidden', 'true');
        submitBtn.insertBefore(spinner, submitBtnText);
      } else {
        submitBtn.disabled = false;
        const spinner = submitBtn.querySelector('.spinner');
        if (spinner) spinner.remove();
        submitBtnIcon.style.display = 'block';
        submitBtnText.textContent = 'Block User';
      }
    }

    function showMessage(text, type){
      messageContainer.innerHTML = `<div class="message ${type}">${text}</div>`;
    }
    function clearMessage(){ messageContainer.innerHTML = ''; }

    function showModalMessage(text, type){
      modalMessage.innerHTML = `<div class="message ${type}">${text}</div>`;
    }
    function clearModalMessage(){ modalMessage.innerHTML = ''; }

    function validEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v); }

    function openModal(){
      confirmModal.classList.add('show');
      confirmModal.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      confirmModal.classList.remove('show');
      confirmModal.setAttribute('aria-hidden','true');
      clearModalMessage();
      reviewDetails.textContent = '';
    }

    // ===== Session: logout =====
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try { await fetch('/api/admin/logout', { method:'POST', credentials:'include' }); } catch(_) {}
      location.replace('/admin.html');
    });

    // ===== Step 1: Validate and open confirmation modal =====
    document.getElementById('blockUserForm').addEventListener('submit', (e) => {
      e.preventDefault();
      clearMessage();

      const userId = document.getElementById('userId').value.trim();
      const email  = document.getElementById('email').value.trim();
      const reason = document.getElementById('reason').value.trim();

      if (!userId) return showMessage('User ID is required.', 'error');
      if (!email || !validEmail(email)) return showMessage('Please enter a valid email address.', 'error');
      if (!reason) return showMessage('Reason is required.', 'error');

      // Fill review summary
      reviewDetails.innerHTML = `
        <div><strong>User ID:</strong> ${escapeHtml(userId)}</div>
        <div><strong>Email:</strong> ${escapeHtml(email)}</div>
        <div><strong>Reason:</strong><br>${escapeHtml(reason)}</div>
      `;

      openModal();
    });

    // ===== Step 2: Confirm and send webhook =====
    async function finalizeBlock(){
      clearModalMessage();
      clearMessage();

      const userId = document.getElementById('userId').value.trim();
      const email  = document.getElementById('email').value.trim();
      const reason = document.getElementById('reason').value.trim();
      const payload = {
        request: "block user",
        user_id: userId,
        email: email,
        reason: reason,
        requested_at_iso: new Date().toISOString()
      };

      try{
        closeModal();
        setLoading(true);

        const res = await fetch('/api/admin/block', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' , credentials: 'include'},
          body: JSON.stringify(payload)
        });

        if (res.status !== 200) {
          showMessage(`Webhook request failed (HTTP ${res.status})`, 'error');
          return;
        }

        const text = (await res.text()).trim();
        if (text === 'approved') {
          showMessage('User blocked successfully.', 'success');
          document.getElementById('blockUserForm').reset();
        } else {
          showMessage(`Unexpected response: "${text}"`, 'error');
        }
      } catch(err){
        showMessage('Network error occurred. Please try again.', 'error');
      } finally {
        setLoading(false);
      }
    }

    confirmBlockBtn.addEventListener('click', finalizeBlock);
    closeModalBtn.addEventListener('click', closeModal);
    cancelConfirmBtn.addEventListener('click', closeModal);

    // Close modal on ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && confirmModal.classList.contains('show')) closeModal();
    });

    // Prevent accidental submit inside modal; Enter confirms explicitly
    confirmModal.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        finalizeBlock();
      }
    });

    // Simple HTML escape for preview
    function escapeHtml(str){
      return str.replace(/[&<>"']/g, (m) => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }
  </script>
</body>
</html>
